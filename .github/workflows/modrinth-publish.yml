name: Modrinth Release Upload

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  MODRINTH_SLUG: better-mason-trades
  MODRINTH_ID: 2BqALtEV
  MOD_ID: better-mason-trades
  PACK_NAME: Better Mason Trades
  PACK_DESCRIPTION: Adds convenient trades for common building blocks (Tuff, Calcite, Bricks, Mud Bricks, Packed Mud, Terracotta) to the Mason
  LICENSE: MIT

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download release asset
        run: |
          gh release download ${{ github.event.release.tag_name }} \
            -p "Better-Mason-Trades-${{ github.event.release.tag_name }}.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version without v prefix
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Publish datapack to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: ${{ env.MODRINTH_ID }}
          name: ${{ github.event.release.name }}
          files: '["Better-Mason-Trades-${{ github.event.release.tag_name }}.zip"]'
          version: ${{ steps.version.outputs.number }}
          changelog: |
            ${{ github.event.release.body }}
            
            ---
            *This release was automatically generated via GitHub Actions*
          loaders: '["datapack"]'
          game-versions: |-
            1.21.9
            1.21.10
            1.21.11
          dependencies: |-
            [{
                "project_id": "OClpEDe3",
                "dependency_type": "required"
            }]

      - name: Bundle datapack as mod
        run: |
          VERSION="${{ steps.version.outputs.number }}"
          MOD_ID="${{ env.MOD_ID }}"
          ID="${{ env.MODRINTH_ID }}"
          ICON_NAME="${{ env.MODRINTH_SLUG }}_pack.png"
          PROJECT_URL="https://modrinth.com/datapack/${{ env.MODRINTH_SLUG }}"
          
          # Extract the datapack
          mkdir mod-temp
          unzip "Better-Mason-Trades-${{ github.event.release.tag_name }}.zip" -d mod-temp
          
          # Copy and rename pack icon for mod loaders
          if [ -f "mod-temp/pack.png" ]; then
            cp mod-temp/pack.png "mod-temp/${ICON_NAME}"
          fi
          
          # Create META-INF directory
          mkdir -p mod-temp/META-INF
          
          # Create mods.toml (Forge)
          cat > mod-temp/META-INF/mods.toml << EOF

          modLoader = 'lowcodefml'
          loaderVersion = '[40,)'
          license = '${{ env.LICENSE }}'
          showAsResourcePack = false
          mods = [
          	{ modId = '${MOD_ID}', version = '${VERSION}', displayName = '${{ env.PACK_NAME }}', description = '${{ env.PACK_DESCRIPTION }}', logoFile = '${ICON_NAME}', updateJSONURL = 'https://api.modrinth.com/updates/${ID}/forge_updates.json', credits = 'Generated by GitHub Actions', authors = 'Fantaz', displayURL = '${PROJECT_URL}' },
          ]

          EOF
          
          # Create neoforge.mods.toml (NeoForge)
          cat > mod-temp/META-INF/neoforge.mods.toml << EOF

          modLoader = 'javafml'
          loaderVersion = '[1,)'
          license = '${{ env.LICENSE }}'
          showAsResourcePack = false
          mods = [
          	{ modId = '${MOD_ID}', version = '${VERSION}', displayName = '${{ env.PACK_NAME }}', description = '${{ env.PACK_DESCRIPTION }}', logoFile = '${ICON_NAME}', updateJSONURL = 'https://api.modrinth.com/updates/${ID}/forge_updates.json?neoforge=only', credits = 'Generated by GitHub Actions', authors = 'Fantaz', displayURL = '${PROJECT_URL}' },
          ]

          EOF
          
          # Create fabric.mod.json (Fabric)
          cat > mod-temp/fabric.mod.json << EOF
          {
            "schemaVersion": 1,
            "id": "${MOD_ID}",
            "version": "${VERSION}",
            "name": "${{ env.PACK_NAME }}",
            "description": "${{ env.PACK_DESCRIPTION }}",
            "authors": ["Fantaz"],
            "contact": {
              "homepage": "${PROJECT_URL}"
            },
            "license": "${{ env.LICENSE }}",
            "icon": "${ICON_NAME}",
            "environment": "*",
            "depends": {
              "fabric-resource-loader-v0": "*"
            }
          }
          EOF
          
          # Create quilt.mod.json (Quilt)
          cat > mod-temp/quilt.mod.json << EOF
          {
            "schema_version": 1,
            "quilt_loader": {
              "group": "com.modrinth",
              "id": "${MOD_ID}",
              "version": "${VERSION}",
              "metadata": {
                "name": "${{ env.PACK_NAME }}",
                "description": "${{ env.PACK_DESCRIPTION }}",
                "contributors": {
                  "Fantaz": "Member"
                },
                "contact": {
                  "homepage": "${PROJECT_URL}"
                },
                "icon": "${ICON_NAME}"
              },
              "intermediate_mappings": "net.fabricmc:intermediary",
              "depends": [
                {
                  "id": "quilt_resource_loader",
                  "versions": "*",
                  "unless": "fabric-resource-loader-v0"
                }
              ]
            }
          }
          EOF
          
          # Package as JAR
          cd mod-temp
          jar cf "../${{ env.MODRINTH_SLUG }}-${{ github.event.release.tag_name }}.jar" .
          cd ..
          
          # Cleanup
          rm -rf mod-temp

      - name: Publish mod to Modrinth
        uses: cloudnode-pro/modrinth-publish@v2
        with:
          token: ${{ secrets.MODRINTH_TOKEN }}
          project: ${{ env.MODRINTH_ID }}
          name: ${{ github.event.release.name }}
          files: '["${{ env.MODRINTH_SLUG }}-${{ github.event.release.tag_name }}.jar"]'
          version: ${{ steps.version.outputs.number }}+mod
          changelog: |
            ${{ github.event.release.body }}
            
            ---
            *This release was automatically generated via GitHub Actions*
          loaders: '["fabric", "neoforge", "quilt"]'
          game-versions: |-
            1.21.9
            1.21.10
            1.21.11
          dependencies: |-
            [{
                "project_id": "P7dR8mSH",
                "dependency_type": "required"
            },
            {
                "project_id": "OClpEDe3",
                "dependency_type": "required"
            }]